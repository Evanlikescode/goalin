{% extends 'layout.html' %}

{% block title %}
Register
{% endblock %}

{% block content %}
<div class="container">
    <div class="card p-5">
        <form  id="register-form">
             {% csrf_token %}
            <div class="row mb-3">
                <h3 style="text-decoration: underline;">Register</h3>
            </div>
            <div class="row mb-3">
                <label class="col-sm-2 col-form-label">{{ form.username.label }}</label>
                <div class="col-sm-10">
                    {{ form.username }}
                    {% if form.username.help_text %}
                        <small>{{ form.username.help_text }}</small>
                    {% endif %}
                     <br>
                    {% for error in form.username.errors %}
                        <small><b>{{ error }}</b></small>
                    {% endfor %}
                </div>
            </div>
            <div class="row mb-3">
               <label class="col-sm-2 col-form-label">{{ form.password1.label }}</label>
                <div class="col-sm-10">
                    {{ form.password1 }}
                    {% if form.password1.help_text %}
                        <small>{{ form.password1.help_text }}</small>
                    {% endif %}
                     <br>
                    {% for error in form.password1.errors %}
                        <small><b>{{ error }}</b></small>
                    {% endfor %}
                </div>
            </div>
             <div class="row mb-3">
               <label class="col-sm-2 col-form-label">{{ form.password2.label }}</label>
                <div class="col-sm-10">
                    {{ form.password2 }}
                    {% if form.password2.help_text %}
                        <small>{{ form.password2.help_text }}</small>
                    {% endif %}
                    <br>
                    {% for error in form.password2.errors %}
                        <small><b>{{ error }}</b></small>
                    {% endfor %}
                </div>
            </div>
            

            <button type="submit" class="btn btn-secondary " style="float: right; width: 9rem;" onsubmit="submitForm()">Register</button>
        </form>
    </div>
</div>

{% include 'toast.html' %}


{% endblock %}

{% block script %}

<script>
document.addEventListener("DOMContentLoaded", () => {

    const form = document.getElementById("register-form")
    const toastElement = new bootstrap.Toast(document.getElementById("toast"))
    const toastBody = document.getElementById("toast-body")

    function showToast(msg, isError=false) {
        const toastEl = document.getElementById("toast")
        toastEl.className = "toast align-items-center border-0"
        toastEl.classList.add(isError ? "text-bg-danger" : "text-bg-success")
        toastBody.textContent = msg
        toastElement.show()
    }


    async function submitForm(e) {
        e.preventDefault()
        const formData = new FormData(form)

        const response = await fetch("{% url 'main:register_user' %}", {
            method: "POST",
            headers: {"X-Requested-With": "XMLHttpRequest"},
            body: formData
        });

        const data = await response.json()

       if (data.success) {
            showToast(data.msg)
            setTimeout(() => window.location.href = "{% url 'main:landing_page' %}", 1000)
        } else {
            let errorMsg = "Registration failed: "
            if (typeof data.msg === 'string') {
                errorMsg += data.msg
            } else if (typeof data.msg === 'object') {
                const errors = []
                Object.entries(data.msg).forEach(([field, fieldErrors]) => {
                    errors.push(`${field}: ${fieldErrors.join(", ")}`)
                })
                errorMsg += errors.join("; ")
            } else {
                errorMsg += "Please check your input"
            }
            showToast(errorMsg, true)
        }
    }

    form.addEventListener("submit", submitForm)




})
    



</script>



{% endblock %}