{% extends 'layout.html' %}

{% block title %}
Login
{% endblock %}

{% block content %}
<div class="container">
    <div class="card p-5">
        <form  id="login-form">
             {% csrf_token %}
            <div class="row mb-3">
                <h3 style="text-decoration: underline;">Login</h3>
            </div>
            <div class="row mb-3">
                <label class="col-sm-2 col-form-label">{{ form.username.label }}</label>
                <div class="col-sm-10">
                    {{ form.username }}
                   
                    
                </div>
            </div>
            <div class="row mb-3">
               <label class="col-sm-2 col-form-label">{{ form.password.label }}</label>
                <div class="col-sm-10">
                    {{ form.password }}
                    
                </div>
            </div>
            

            

            <button type="submit" class="btn btn-secondary " style="float: right; width: 9rem;">Login</button>
            <p>Don't have an account? <br> <a class="row" href="{% url 'main:register_user' %}">Register Now</a></p>
            

        </form>
    </div>
</div>

{% include 'toast.html' %}

{% endblock %}


{% block script %}

<script>

document.addEventListener("DOMContentLoaded", () => {

    const form = document.getElementById("login-form")
    const toastElement = new bootstrap.Toast(document.getElementById("toast"))
    const toastBody = document.getElementById("toast-body")

    function showToast(msg, isError=false) {
        const toastEl = document.getElementById("toast")
        toastEl.className = "toast align-items-center border-0"
        toastEl.classList.add(isError ? "text-bg-danger" : "text-bg-success")
        toastBody.textContent = msg
        toastElement.show()
    }


    async function submitForm(e) {
        e.preventDefault()
        const formData = new FormData(form)

        const response = await fetch("{% url 'main:login_user' %}", {
            method: "POST",
            headers: {"X-Requested-With": "XMLHttpRequest"},
            body: formData
        });

        const data = await response.json()

       if (data.success) {
            showToast(data.msg)
            setTimeout(() => window.location.href = "{% url 'main:landing_page' %}", 1000)
        } else {
            let errorMsg = "Login failed: "
            if (typeof data.msg === 'string') {
                errorMsg += data.msg
            } else if (typeof data.msg === 'object') {
                const errors = []
                Object.entries(data.msg).forEach(([field, fieldErrors]) => {
                    errors.push(`${field}: ${fieldErrors.join(", ")}`)
                })
                errorMsg += errors.join("; ")
            } else {
                errorMsg += "Please check your input"
            }
            showToast(errorMsg, true)
        }
    }

    form.addEventListener("submit", submitForm)




})










</script>

{% endblock %}